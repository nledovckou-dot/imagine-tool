<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Imagine Tool</title>
<style>
* { box-sizing: border-box; margin: 0; padding: 0; }
body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #111; color: #eee; min-height: 100vh; display: flex; justify-content: center; padding: 20px; }
.app { max-width: 900px; width: 100%; }
h1 { font-size: 22px; margin-bottom: 20px; font-weight: 500; }
.form-group { margin-bottom: 16px; }
label { display: block; font-size: 13px; color: #888; margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px; }
textarea { width: 100%; background: #1a1a1a; border: 1px solid #333; color: #eee; padding: 12px; border-radius: 8px; font-size: 15px; resize: vertical; min-height: 80px; font-family: inherit; }
textarea:focus { outline: none; border-color: #555; }
.photos-area { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
.photo-thumb { width: 80px; height: 80px; border-radius: 8px; object-fit: cover; border: 1px solid #333; }
.add-photo { width: 80px; height: 80px; border-radius: 8px; border: 2px dashed #444; display: flex; align-items: center; justify-content: center; cursor: pointer; color: #666; font-size: 28px; transition: border-color 0.2s; }
.add-photo:hover { border-color: #888; color: #aaa; }
input[type="file"] { display: none; }
button.go { width: 100%; padding: 14px; background: #fff; color: #000; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; transition: opacity 0.2s; }
button.go:hover { opacity: 0.85; }
button.go:disabled { opacity: 0.3; cursor: not-allowed; }
.log { margin-top: 24px; }
.log-entry { padding: 8px 12px; background: #1a1a1a; border-radius: 6px; margin-bottom: 6px; font-size: 14px; border-left: 3px solid #333; }
.log-entry.active { border-left-color: #f0c040; }
.log-entry.done { border-left-color: #4caf50; }
.log-entry.error { border-left-color: #f44; color: #f88; }
.log-entry.partial { border-left-color: #4caf50; color: #8f8; }
.brief { margin-top: 16px; padding: 12px; background: #1a1a1a; border-radius: 8px; font-size: 13px; line-height: 1.5; color: #bbb; white-space: pre-wrap; }
.brief b { color: #eee; }
.result { margin-top: 24px; }
.result img { width: 100%; border-radius: 8px; margin-bottom: 12px; }
.videos-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 16px; margin-top: 16px; }
.video-card { background: #1a1a1a; border-radius: 8px; overflow: hidden; }
.video-card video { width: 100%; display: block; }
.video-card .video-label { padding: 8px 12px; font-size: 13px; color: #aaa; display: flex; justify-content: space-between; align-items: center; }
.video-card .video-label span { font-weight: 600; color: #eee; }
.video-card .video-label a { color: #8af; text-decoration: none; font-size: 12px; }
.video-card .video-label a:hover { text-decoration: underline; }
.download-row { display: flex; gap: 8px; margin-top: 12px; flex-wrap: wrap; }
.download-row a { padding: 8px 16px; background: #222; color: #eee; text-decoration: none; border-radius: 6px; font-size: 13px; transition: background 0.2s; }
.download-row a:hover { background: #333; }
.spinner { display: inline-block; width: 14px; height: 14px; border: 2px solid #555; border-top-color: #f0c040; border-radius: 50%; animation: spin 0.8s linear infinite; margin-right: 8px; vertical-align: middle; }
@keyframes spin { to { transform: rotate(360deg); } }
.history { margin-top: 40px; border-top: 1px solid #222; padding-top: 20px; }
.history h2 { font-size: 16px; font-weight: 500; margin-bottom: 12px; color: #888; }
.history-item { display: flex; gap: 12px; padding: 12px; background: #1a1a1a; border-radius: 8px; margin-bottom: 8px; cursor: pointer; transition: background 0.2s; }
.history-item:hover { background: #222; }
.history-item img { width: 60px; height: 60px; border-radius: 6px; object-fit: cover; flex-shrink: 0; }
.history-item .info { font-size: 13px; color: #aaa; overflow: hidden; }
.history-item .info .title { color: #eee; margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
</style>
</head>
<body>
<div class="app">
  <h1>Imagine Tool</h1>

  <div class="form-group">
    <label>Идея</label>
    <textarea id="idea" placeholder="Опиши что хочешь: горы Осетии, кофейня, фитнес, реклама мерседеса..."></textarea>
  </div>

  <div class="form-group">
    <label>Референсы (до 3 фото)</label>
    <div class="photos-area" id="photosArea">
      <div class="add-photo" id="addPhoto" title="Добавить фото">+</div>
    </div>
    <input type="file" id="fileInput" accept="image/*" multiple>
  </div>

  <button class="go" id="goBtn" onclick="startGeneration()">Создать картинку + 3 видео</button>

  <div class="log" id="log"></div>
  <div id="briefBox"></div>
  <div class="result" id="result"></div>

  <div class="history" id="historySection" style="display:none">
    <h2>История</h2>
    <div id="historyList"></div>
  </div>
</div>

<script>
const photoFiles = [];
const MAX_PHOTOS = 3;
let history = [];

const fileInput = document.getElementById('fileInput');
const photosArea = document.getElementById('photosArea');
const addPhotoBtn = document.getElementById('addPhoto');

addPhotoBtn.addEventListener('click', () => {
  if (photoFiles.length < MAX_PHOTOS) fileInput.click();
});

fileInput.addEventListener('change', (e) => {
  for (const f of e.target.files) {
    if (photoFiles.length >= MAX_PHOTOS) break;
    photoFiles.push(f);
    const img = document.createElement('img');
    img.className = 'photo-thumb';
    img.src = URL.createObjectURL(f);
    photosArea.insertBefore(img, addPhotoBtn);
  }
  if (photoFiles.length >= MAX_PHOTOS) addPhotoBtn.style.display = 'none';
  fileInput.value = '';
});

function addLog(msg, cls = '') {
  const log = document.getElementById('log');
  const div = document.createElement('div');
  div.className = 'log-entry ' + cls;
  div.innerHTML = (cls === 'active' ? '<span class="spinner"></span>' : '') + msg;
  log.appendChild(div);
  div.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
  return div;
}

function clearResults() {
  document.getElementById('log').innerHTML = '';
  document.getElementById('briefBox').innerHTML = '';
  document.getElementById('result').innerHTML = '';
}

async function startGeneration() {
  const idea = document.getElementById('idea').value.trim();
  if (!idea) { alert('Напиши идею'); return; }

  const btn = document.getElementById('goBtn');
  btn.disabled = true;
  clearResults();

  const fd = new FormData();
  fd.append('idea', idea);
  photoFiles.forEach((f, i) => fd.append('photo' + i, f));

  let activeLog = addLog('Отправляю...', 'active');

  try {
    const resp = await fetch('/api/generate', { method: 'POST', body: fd });
    const data = await resp.json();
    if (data.error) throw new Error(data.error);

    const jobId = data.job_id;
    activeLog.remove();

    const es = new EventSource('/api/stream/' + jobId);
    let imageUrl = null;

    es.onmessage = (e) => {
      const ev = JSON.parse(e.data);

      // Remove previous active spinners (but keep partial results)
      document.querySelectorAll('.log-entry.active').forEach(el => {
        el.classList.remove('active');
        el.querySelector('.spinner')?.remove();
      });

      if (ev.step === 'error') {
        addLog(ev.msg, 'error');
        es.close();
        btn.disabled = false;
        return;
      }

      if (ev.step === 'video_partial') {
        addLog(ev.msg, 'partial');
        return;
      }

      if (ev.step === 'video_error') {
        addLog(ev.msg, 'error');
        return;
      }

      if (ev.step === 'done') {
        addLog(ev.msg || 'Готово!', 'done');
        const r = document.getElementById('result');

        // Show all videos in a grid
        if (ev.videos && ev.videos.length > 0) {
          let grid = '<div class="videos-grid">';
          for (const v of ev.videos) {
            grid += `<div class="video-card">
              <video controls autoplay loop muted playsinline><source src="${v.url}" type="video/mp4"></video>
              <div class="video-label"><span>${esc(v.provider)}</span><a href="${v.url}" download>Скачать</a></div>
            </div>`;
          }
          grid += '</div>';
          r.innerHTML += grid;
        } else if (ev.video) {
          r.innerHTML += `<video controls autoplay loop><source src="${ev.video}" type="video/mp4"></video>`;
        }

        // Download row
        let dl = '<div class="download-row">';
        if (imageUrl) dl += `<a href="${imageUrl}" download>Скачать картинку</a>`;
        if (ev.videos) {
          for (const v of ev.videos) {
            dl += `<a href="${v.url}" download>Скачать ${esc(v.provider)}</a>`;
          }
        }
        dl += '</div>';
        r.innerHTML += dl;

        if (ev.errors && ev.errors.length > 0) {
          for (const err of ev.errors) {
            addLog(err, 'error');
          }
        }

        saveHistory();
        es.close();
        btn.disabled = false;
        return;
      }

      if (ev.step === 'gpt_done') {
        addLog('Бриф готов', '');
        const bb = document.getElementById('briefBox');
        bb.innerHTML = `<div class="brief"><b>Картинка:</b> ${esc(ev.img_prompt)}\n\n<b>Видео:</b> ${esc(ev.vid_prompt)}</div>`;
      } else if (ev.step === 'dalle_done') {
        addLog('Картинка готова!', '');
        imageUrl = ev.image;
        if (imageUrl) {
          document.getElementById('result').innerHTML = `<img src="${imageUrl}">`;
        }
      } else {
        addLog(ev.msg, 'active');
      }
    };

    es.onerror = () => {
      es.close();
      btn.disabled = false;
    };

  } catch (err) {
    addLog('Ошибка: ' + err.message, 'error');
    btn.disabled = false;
  }
}

function esc(s) {
  const d = document.createElement('div');
  d.textContent = s;
  return d.innerHTML;
}

function saveHistory() {
  loadHistory();
}

async function loadHistory() {
  try {
    const resp = await fetch('/api/history');
    history = await resp.json();
  } catch (e) {
    history = [];
  }
  renderHistory();
}

function renderHistory() {
  const section = document.getElementById('historySection');
  const list = document.getElementById('historyList');
  if (!history.length) { section.style.display = 'none'; return; }
  section.style.display = '';
  list.innerHTML = history.map((h, i) => `
    <div class="history-item" data-idx="${i}">
      ${h.image ? `<img src="${h.image}">` : ''}
      <div class="info">
        <div class="title">${esc(h.idea)}</div>
        <div>${h.provider || ''} &middot; ${new Date(h.ts).toLocaleString('ru')}</div>
      </div>
    </div>
  `).join('');
  list.querySelectorAll('.history-item').forEach(el => {
    el.addEventListener('click', () => {
      const h = history[el.dataset.idx];
      showHistoryItem(h.image, h.videos || (h.video ? [{provider: h.provider, url: h.video}] : []));
    });
  });
}

function showHistoryItem(img, videos) {
  const r = document.getElementById('result');
  r.innerHTML = '';
  if (img) r.innerHTML += `<img src="${img}">`;
  if (videos && videos.length > 0) {
    let grid = '<div class="videos-grid">';
    for (const v of videos) {
      grid += `<div class="video-card">
        <video controls autoplay loop muted playsinline><source src="${v.url}" type="video/mp4"></video>
        <div class="video-label"><span>${esc(v.provider)}</span><a href="${v.url}" download>Скачать</a></div>
      </div>`;
    }
    grid += '</div>';
    r.innerHTML += grid;
  }
  r.scrollIntoView({ behavior: 'smooth' });
}

loadHistory();
</script>
</body>
</html>
